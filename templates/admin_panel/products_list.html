{% extends 'base.html' %}
{% load static %}

{% block styles %}
    <link rel="stylesheet" href="{% static 'css/filter_form.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/pagination.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/sort.css' %}"/>
    <link rel="stylesheet" href="{% static 'css/admin_products.css' %}"/>
{% endblock %}

{% block javascript %}
    <script>
        function openProductAddForm() {
            document.getElementById("outer_product_form").style.display = "flex";
        }

        function closeProductAddForm() {
            document.getElementById("outer_product_form").style.display = "none";
        }

        function addImageForm() {
            let imgForm = document.querySelectorAll(".img-form");
            let container = document.querySelector("#product_add_form");
            let buttonsDiv = document.querySelector("#product_form_buttons");
            let totalForms = document.querySelector("#id_form-TOTAL_FORMS");

            let formNum = imgForm.length - 1;

            if (formNum < {{ max_img_num }} -1) {
                let newForm = imgForm[0].cloneNode(true);
                let formRegex = RegExp(`form-(\\d){1}-`, 'g');
                formNum++;
                newForm.innerHTML = newForm.innerHTML.replace(formRegex, `form-${formNum}-`);
                container.insertBefore(newForm, buttonsDiv);

                let currentForm = document.querySelector(`#id_form-${formNum}-image`).parentNode;
                let inputError = currentForm.querySelector('.errorlist');
                if (inputError) {
                    inputError.remove();
                }

                totalForms.setAttribute('value', `${formNum + 1}`);
            } else if (formNum === {{ max_img_num }} -1) {
                var error = document.getElementById("images_error");
                if (!error) {
                    let p = document.createElement('p');
                    p.id = "images_error";
                    p.innerHTML = 'Товар может иметь максимум 3 изображения';
                    container.insertBefore(p, buttonsDiv);
                }
            }
            document.getElementById('btn_add_prod').scrollIntoView();
        }
        {% if form.errors or form.image_formset.errors %}
            document.addEventListener("DOMContentLoaded", function () {
                document.getElementById("outer_product_form").style.display = "flex";
            });
        {% endif %}
    </script>
{% endblock %}

{% block content %}
    <div class="container">
        {% if messages %}
            <div class="alert alert-danger" role="alert">
                {% for message in messages %}
                    {{ message }}
                {% endfor %}
            </div>
        {% endif %}
        <div class="body_outer">
            <div class="left_panel">
                {% include 'utils/filter_products.html' %}
            </div>
            <div class="right_panel">
                <div id="outer_product_form">
                    <div id="form_box">
                        <form id="product_add_form" method="post" enctype="multipart/form-data">
                            <div class="close_button">
                                <button type="button" class="btn" onclick="closeProductAddForm()">
                                    <i class="fa fa-times close_btn" aria-hidden="true"></i>
                                </button>
                            </div>
                            <h3 class="form_title">Добавление товара</h3>
                            {% csrf_token %}
                            {% for field in form %}
                                <div class="form_field">
                                    {{ field.label_tag }}
                                    {{ field }}
                                    {{ field.errors }}
                                </div>
                            {% endfor %}
                            {{ form.image_formset.management_form }}
                            {% for form in form.image_formset %}
                                <div class="img-form">
                                    {% for field in form %}
                                        <div class="form_field">
                                            {{ field.label_tag }}
                                            {{ field }}
                                            {{ field.errors }}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}
                            <div id="product_form_buttons">
                                <button id="btn_add_img" class="btn" type="button"
                                        onclick="addImageForm()">
                                    Добавить еще одно изображение
                                </button>
                                <button id="btn_add_prod" class="btn" type="submit">Добавить</button>
                            </div>
                        </form>
                    </div>
                </div>
                <a class="btn btn-primary" onclick="openProductAddForm()">Добавить новый товар</a>
                {% include 'utils/sort_products.html' %}
                {#                {% if products %}#}
                {#                    <table class="table">#}
                {#                        <thead>#}
                {#                        <tr>#}
                {#                            <th scope="col">id</th>#}
                {#                            <th scope="col">Image</th>#}
                {#                            <th scope="col">Name</th>#}
                {#                            <th scope="col">Price</th>#}
                {#                            <th scope="col">Amount</th>#}
                {#                            <th scope="col">Vendor</th>#}
                {#                            <th scope="col">Category</th>#}
                {#                            <th scope="col">Date created</th>#}
                {#                            <th></th>#}
                {#                            <th></th>#}
                {#                        </tr>#}
                {#                        </thead>#}
                {#                        <tbody>#}
                {#                        {% for product in products %}#}
                {#                            <tr>#}
                {#                                <th scope="row"><a href="{% url 'product-update' pk=product.id %}">{{ product.id }}</a>#}
                {#                                </th>#}
                {#                                <td><img src="{% get_media_prefix %}{{ product.image }}" width="100" height="100"#}
                {#                                         alt='product_image'></td>#}
                {#                                <td>{{ product.name }}</td>#}
                {#                                <td>{{ product.price }}</td>#}
                {#                                <td>{{ product.amount }}</td>#}
                {#                                <td>{{ product.vendor__name }}</td>#}
                {#                                <td>{{ product.category__name }}</td>#}
                {#                                <td>{{ product.date_created }}</td>#}
                {#                                <td>#}
                {#                                    <a class="btn btn-primary"#}
                {#                                       href="{% url 'product-update' pk=product.id %}">Изменить</a>#}
                {#                                </td>#}
                {#                                <td>#}
                {#                                    <a class="btn btn-danger"#}
                {#                                       href="{% url 'product-delete' pk=product.id %}">Удалить</a>#}
                {#                                </td>#}
                {#                            </tr>#}
                {#                        {% endfor %}#}
                {#                        </tbody>#}
                {#                    </table>#}
                {#                    {% include 'utils/pagination.html' %}#}
                {#                {% else %}#}
                {#                    <p>К сожалению, список товаров пуст</p>#}
                {#                {% endif %}#}
            </div>
        </div>
    </div>
{% endblock %}
